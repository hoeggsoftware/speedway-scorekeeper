<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:whisperer="http://www.mulesoft.org/schema/mule/whisperer"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/whisperer http://www.mulesoft.org/schema/mule/whisperer/current/mule-whisperer.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd">
	<ee:object-store-caching-strategy name="referenceDataCache" doc:name="Caching Strategy" doc:id="d75ac186-1b7a-4d85-9788-f30ce928ed8d" keyGenerationExpression='#["f1Results"]' >
		<os:private-object-store alias="referenceDataCache" persistent="false" entryTtl="8" entryTtlUnit="HOURS" expirationInterval="20" />
	</ee:object-store-caching-strategy>
	<sub-flow name="generateFormulaOneQuestion" doc:id="a566aab7-cbb5-4db1-82d0-3610e64563de" >
		<ee:transform doc:name="f1Results" doc:id="b5c5ceda-4a23-44b2-81f1-1d6f7753355b">
			<ee:message>
			</ee:message>
				<ee:variables>
					<ee:set-variable variableName="f1Results"><![CDATA[%dw 2.0
output application/java

var rawResults = readUrl("classpath://data/f1-results-kaggle.csv", "application/csv")
---
rawResults map (row) -> {
	season: row.Season,
	round: row.Round,
	position: row.Position,
	driver: {
		first: row.GivenName,
		last: row.FamilyName,
		nationality: row.Nationality
	},
	constructor: {
		name: row.ConstructorName,
		nationality: row.ConstructorNationality
	},
	status: row.Status
}]]></ee:set-variable>
				</ee:variables>
		</ee:transform>
		<set-variable value='#[output application/java&#10;var possibleFacts = [&#10;	"driverLastName",&#10;	"constructor", &#10;	// constructor nationality question seems confusing, removing&#10;	//"constructorNationality",&#10;	"position",&#10;]&#10;---&#10;{&#10;	fact: possibleFacts[randomInt(sizeOf(possibleFacts))],&#10;	formulaOneRecord: vars.f1Results[randomInt(sizeOf(vars.f1Results))]&#10;}]' doc:name="selectedChallenge" doc:id="b4db31f4-6817-48dd-900a-14c894b12f68" variableName="selectedChallenge"/>
		<logger level="DEBUG" doc:name="DEBUG" doc:id="ddb3115a-64f1-430c-bee6-65cf1adc4034" message="#[output application/json --- vars.selectedChallenge]" category="scorekeeper-sapi.check-simple-question.generate"/>
		<ee:transform doc:name="question and answer" doc:id="a632d6aa-01b0-4966-9a82-f5e11a560578" >
			<ee:message >
				<ee:set-payload resource="transformations/generateQuestion.dwl" />
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
	</sub-flow>
	<sub-flow name="checkFormulaOneQuestion" doc:id="f60d83a6-cd18-4d7c-9b1e-7269df7d6d9f" >
		<whisperer:text-to-speech doc:name="questionSpeech" doc:id="6ab97d86-5bc4-45c1-b671-90d7a5cba10f" config-ref="MAC_Whisperer_Config" target="questionSpeech">
			<whisperer:text ><![CDATA[#[vars.questionText]]]></whisperer:text>
			<whisperer:generation-options modelName="tts-1-hd" />
		</whisperer:text-to-speech>
	</sub-flow>
</mule>
